@page "/absences"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject Pusula.UI.Services.ApiClient Api
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components

<h3>Absences</h3>

@if (isTeacher)
{
	<div class="card mb-3">
		<div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" @onclick="ToggleAddAbsenceForm">
			<h5 class="mb-0">Add New Absence</h5>
			<i class="fas fa-chevron-@(showAddAbsenceForm ? "up" : "down")"></i>
		</div>
		@if (showAddAbsenceForm)
		{
			<div class="card-body">
				<EditForm Model="newAbsence" OnValidSubmit="AddAbsence" FormName="addAbsenceForm">
					<DataAnnotationsValidator />
					<div class="row">
						<div class="col-md-6 mb-3">
							<label for="courseSelect" class="form-label">Course</label>
							<InputSelect id="courseSelect" @bind-Value="selectedCourseId" @bind-Value:after="OnCourseChanged" class="form-control" TValue="string">
								<option value="">Select a course...</option>
								@if (teacherCourses != null)
								{
									@foreach (var course in teacherCourses)
									{
										<option value="@course.Id">@course.Name</option>
									}
								}
							</InputSelect>
							<ValidationMessage For="@(() => newAbsence.CourseId)" />
						</div>
						<div class="col-md-6 mb-3">
							<label for="studentSelect" class="form-label">Student</label>
							<InputSelect id="studentSelect" @bind-Value="newAbsence.StudentId" class="form-control" disabled="@isLoadingCourseStudents">
								<option value="">@(isLoadingCourseStudents ? "Loading students..." : "Select a student...")</option>
								@if (courseStudents != null && courseStudents.Any())
								{
									@foreach (var student in courseStudents)
									{
										<option value="@student.Id">@student.FullName</option>
									}
								}
								else if (!isLoadingCourseStudents && !string.IsNullOrEmpty(selectedCourseId))
								{
									<option value="" disabled>No students enrolled in this course</option>
								}
							</InputSelect>
							<ValidationMessage For="@(() => newAbsence.StudentId)" />
							@if (isLoadingCourseStudents)
							{
								<small class="text-muted">Loading students...</small>
							}
							else if (courseStudents != null)
							{
								<small class="text-muted">Enrolled students: @courseStudents.Count</small>
							}
							else if (!string.IsNullOrEmpty(selectedCourseId))
							{
								<small class="text-muted">No students enrolled in this course</small>
							}
						</div>
					</div>
					<div class="row">
						<div class="col-md-6 mb-3">
							<label for="absenceDate" class="form-label">Date</label>
							<InputDate id="absenceDate" @bind-Value="newAbsence.Date" class="form-control" />
							<ValidationMessage For="@(() => newAbsence.Date)" />
						</div>
						<div class="col-md-6 mb-3">
							<label for="reason" class="form-label">Reason</label>
							<InputText id="reason" @bind-Value="newAbsence.Reason" class="form-control" placeholder="Enter reason for absence" />
						</div>
					</div>
					<div class="d-flex gap-2">
						<button type="submit" class="btn btn-primary" disabled="@isAddingAbsence">
							@if (isAddingAbsence)
							{
								<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
							}
							Add Absence
						</button>
						<button type="button" class="btn btn-secondary" @onclick="CancelAddAbsence">Cancel</button>
					</div>
				</EditForm>
			</div>
		}
	</div>
}

@if (isStudent)
{
	@if (currentStudent != null)
	{
		<div class="alert alert-info">
			<h5>My Absences</h5>
			<p class="mb-0">Showing absences for: <strong>@currentStudent.FullName</strong></p>
		</div>
	}
}
else
{
	<EditForm Model="query" OnValidSubmit="Load" FormName="absencesForm">
		<div class="mb-2">
			<label>Student</label>
			<InputSelect @bind-Value="query.StudentId" class="form-control">
				<option value="">Select a student...</option>
				@if (students != null)
				{
					@foreach (var student in students)
					{
						<option value="@student.Id">@student.FullName</option>
					}
				}
			</InputSelect>
		</div>
		<button class="btn btn-secondary" type="submit">Load</button>
	</EditForm>
}

@if (absences == null) 
{ 
	@if (isStudent)
	{
		<p>Loading your absences...</p>
	}
	else
	{
		<p>Select a student and click Load.</p>
	}
}
else
{
	<table class="table">
		<thead><tr><th>Course</th><th>Date</th><th>Reason</th></tr></thead>
		<tbody>
			@foreach (var a in absences)
			{
				<tr><td>@GetCourseName(a.CourseId)</td><td>@a.Date.ToShortDateString()</td><td>@a.Reason</td></tr>
			}
		</tbody>
	</table>
}

@code {
	bool isLoadingCourseStudents = false;
	class AbsenceDto { public string Id { get; set; }=string.Empty; public string StudentId { get; set; }=string.Empty; public string CourseId { get; set; }=string.Empty; public DateTime Date { get; set; } public string? Reason { get; set; } }
	class StudentDto { public string Id { get; set; }=string.Empty; public string UserId { get; set; }=string.Empty; public string Email { get; set; }=string.Empty; public string FullName { get; set; }=string.Empty; public DateTime EnrollmentDate { get; set; } }
	class CourseDto { public string Id { get; set; }=string.Empty; public string Name { get; set; }=string.Empty; public string? Description { get; set; } public int Status { get; set; } public string TeacherId { get; set; }=string.Empty; public string TeacherName { get; set; }=string.Empty; }
	class Query { public string StudentId { get; set; } = string.Empty; }
	class AddAbsenceRequest 
	{ 
		[Required(ErrorMessage = "Please select a course")]
		public string CourseId { get; set; }=string.Empty; 
		
		[Required(ErrorMessage = "Please select a student")]
		public string StudentId { get; set; }=string.Empty; 
		
		[Required(ErrorMessage = "Date is required")]
		public DateTime Date { get; set; } = DateTime.Today;
		
		public string? Reason { get; set; }
	}
	
	Query query = new();
	AddAbsenceRequest newAbsence = new();
	List<AbsenceDto>? absences;
	List<StudentDto>? students;
	List<CourseDto>? courses;
	List<CourseDto>? teacherCourses;
	List<StudentDto>? courseStudents;
	Dictionary<string, string> courseNames = new();
	bool isTeacher = false;
	bool isStudent = false;
	bool isAddingAbsence = false;
	bool showAddAbsenceForm = false;
	string selectedCourseId = string.Empty;
	StudentDto? currentStudent = null;
	
	protected override async Task OnInitializedAsync()
	{
		// Check user roles
		var authState = await AuthStateProvider.GetAuthenticationStateAsync();
		isTeacher = authState.User.IsInRole("Teacher");
		isStudent = authState.User.IsInRole("Student");
		
		// Load data
		students = await Api.GetAsync<List<StudentDto>>("api/students");
		courses = await Api.GetAsync<List<CourseDto>>("api/courses");
		courseNames = courses?.ToDictionary(c => c.Id, c => c.Name) ?? new Dictionary<string, string>();
		
		// Load teacher courses if user is teacher
		if (isTeacher)
		{
			teacherCourses = await Api.GetAsync<List<CourseDto>>("api/teachers/my-courses");
		}
		
		// Load current student info and their absences if user is student
		if (isStudent)
		{
			currentStudent = await Api.GetAsync<StudentDto>("api/students/me");
			if (currentStudent != null)
			{
				absences = await Api.GetAsync<List<AbsenceDto>>($"api/absences/by-student/{currentStudent.Id}");
			}
		}
	}
	
	async Task Load()
	{
		if (!string.IsNullOrWhiteSpace(query.StudentId))
			absences = await Api.GetAsync<List<AbsenceDto>>($"api/absences/by-student/{query.StudentId}");
	}
	
	async Task OnCourseChanged()
	{
		newAbsence.CourseId = selectedCourseId;
		
		if (!string.IsNullOrEmpty(selectedCourseId))
		{
			isLoadingCourseStudents = true;
			courseStudents = null; // Clear previous results
			newAbsence.StudentId = string.Empty; // Reset student selection
			
			try
			{
				Console.WriteLine($"Loading students for course ID: {selectedCourseId}");
				
				// Validate GUID format
				if (!Guid.TryParse(selectedCourseId, out var courseGuid))
				{
					Console.WriteLine($"Invalid GUID format: {selectedCourseId}");
					courseStudents = new List<StudentDto>();
					return;
				}
				
				courseStudents = await Api.GetAsync<List<StudentDto>>($"api/teachers/my-courses/{selectedCourseId}/students");
				Console.WriteLine($"API returned {courseStudents?.Count ?? 0} students");
				
				// Only show course students, no fallback to all students
				if (courseStudents == null)
				{
					courseStudents = new List<StudentDto>();
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error loading course students: {ex.Message}");
				courseStudents = new List<StudentDto>(); // Show empty list if there's an error
			}
			finally
			{
				isLoadingCourseStudents = false;
			}
		}
		else
		{
			courseStudents = null;
			newAbsence.StudentId = string.Empty; // Reset student selection
		}
	}
	
	async Task AddAbsence()
	{
		if (isAddingAbsence) return;
		
		isAddingAbsence = true;
		try
		{
			// Convert date to UTC for PostgreSQL compatibility
			var absenceRequest = new AddAbsenceRequest
			{
				CourseId = newAbsence.CourseId,
				StudentId = newAbsence.StudentId,
				Date = newAbsence.Date.ToUniversalTime(),
				Reason = newAbsence.Reason
			};
			
			Console.WriteLine($"Adding absence: CourseId={absenceRequest.CourseId}, StudentId={absenceRequest.StudentId}, Date={absenceRequest.Date:yyyy-MM-dd HH:mm:ss} UTC, Reason={absenceRequest.Reason}");
			
			var response = await Api.PostAsync("api/absences", absenceRequest);
			
			if (response.IsSuccessStatusCode)
			{
				// Reset form and close
				newAbsence = new AddAbsenceRequest();
				selectedCourseId = string.Empty;
				showAddAbsenceForm = false;
				courseStudents = null;
				await JS.InvokeVoidAsync("alert", "Absence added successfully!");
			}
			else
			{
				var errorContent = await response.Content.ReadAsStringAsync();
				await JS.InvokeVoidAsync("alert", $"Error adding absence: {response.StatusCode} - {errorContent}");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error adding absence: {ex.Message}");
			await JS.InvokeVoidAsync("alert", $"Error adding absence: {ex.Message}");
		}
		finally
		{
			isAddingAbsence = false;
		}
	}
	
	void CancelAddAbsence()
	{
		newAbsence = new AddAbsenceRequest();
		selectedCourseId = string.Empty;
		showAddAbsenceForm = false;
		courseStudents = null;
	}
	
	void ToggleAddAbsenceForm()
	{
		showAddAbsenceForm = !showAddAbsenceForm;
		if (!showAddAbsenceForm)
		{
			// Reset form when closing
			newAbsence = new AddAbsenceRequest();
			selectedCourseId = string.Empty;
			courseStudents = null;
		}
	}
	
	string GetCourseName(string courseId)
	{
		return courseNames.TryGetValue(courseId, out var name) ? name : courseId;
	}
}


